# MEZ Validator

A command-line tool for validating fMP4 mezzanine segment files generated by the avpipe transcoding system.

## Overview

The MEZ validator checks fMP4 (fragmented MP4) mezzanine files for compliance with expected patterns and standards. It validates:

- **Uniform Sample Durations**: All samples within each track have consistent duration
- **Sequential MFHD Sequence Numbers**: Movie Fragment Header sequence numbers start from 1 and increment sequentially
- **TFDT Base Media Decode Time**: First fragment starts at time zero, subsequent fragments follow cumulative sample duration pattern
- **Average Bitrate Calculation**: Automatically calculates and reports average bitrate based on file size and duration

## Installation

Build the validator from the avpipe project root:

```bash
cd avpipe/
go build -o bin/mez-validator ./cmd/mez-validator
```

## Usage

### Validate a Single File

```bash
./bin/mez-validator video-mez-segment-1.mp4
```

### Validate All MP4 Files in a Directory

```bash
./bin/mez-validator ./mez_output/
```

## Output Format

The validator outputs JSON reports for each validated file:

```json
{
  "pass": true,
  "filename": "video-mez-segment-1.mp4",
  "sample_count": 840,
  "common_sample_duration": 3600,
  "common_duration_seconds": 0.04,
  "timescale": 90000,
  "total_duration": 3024000,
  "total_duration_seconds": 33.6,
  "file_size": 506271,
  "average_bitrate_bps": 120540
}
```

### Output Fields

- **pass**: `true` if file passes all validation checks, `false` if any issues are found
- **filename**: Path to the validated file
- **sample_count**: Total number of media samples in all tracks
- **common_sample_duration**: Expected duration for all samples (in timescale units)
- **common_duration_seconds**: Expected sample duration in seconds
- **timescale**: Media timescale (units per second) from the track header
- **total_duration**: Total media duration in timescale units
- **total_duration_seconds**: Total media duration in seconds
- **file_size**: File size in bytes
- **average_bitrate_bps**: Average bitrate in bits per second, calculated as `(file_size × 8) ÷ duration_seconds`

### Validation Errors

When validation fails, additional fields show the specific issues:

```json
{
  "pass": false,
  "filename": "bad-segment.mp4",
  "sample_count": 900,
  "common_sample_duration": 1001,
  "duration_variations": [
    {
      "sample_index": 450,
      "actual_duration": 1002
    }
  ],
  "sequence_number_errors": [
    {
      "fragment_index": 2,
      "actual_sequence": 4,
      "expected_sequence": 3
    }
  ],
  "tfdt_time_errors": [
    {
      "fragment_index": 1,
      "actual_base_time": 100000,
      "expected_base_time": 90090
    }
  ]
}
```

### Concise Reporting

The validator uses a concise JSON format:

- **Regular patterns are omitted**: If sequence numbers and TFDT times follow expected patterns, they're not included in the output
- **Only deviations are reported**: Duration variations, sequence errors, and timing errors are only shown when issues are detected
- **omitempty tags**: Empty arrays and zero values are excluded from JSON output

## Validation Rules

### Sample Duration Uniformity
- All samples in a track must have the same duration
- Uses MP4 specification hierarchy: TRUN sample durations → TFHD default → TREX default

### MFHD Sequence Numbers
- Must start from 1 and increment by 1 for each fragment
- No gaps or duplicates allowed

### TFDT Base Media Decode Time
- First fragment must start at base time 0
- Subsequent fragments must start at cumulative duration of previous samples
- Ensures proper timeline continuity

## Integration

The validator can be integrated into automated workflows:

```bash
# Exit code 0 = all files valid, non-zero = validation failed
./bin/mez-validator ./output/ && echo "All files valid"

# Parse JSON output for programmatic processing
./bin/mez-validator file.mp4 | jq '.pass'
```

## Testing

The validator includes comprehensive tests that verify both valid and invalid MEZ files:

```bash
# Run all tests
go test -v

# Run specific test
go test -v -run TestValidateVideoMezSegment1
```

### Test Coverage

- **TestValidateVideoMezSegment1**: Validates against known good MEZ file with expected metrics
- **TestValidateModifiedVideoMezSegment**: Tests error detection by modifying sample durations in the MP4 structure

The test suite includes a helper function `createModifiedMP4()` that demonstrates how to programmatically modify MP4 files for testing validation error scenarios.

## Dependencies

- Uses `github.com/Eyevinn/mp4ff` library for MP4 parsing
- Requires Go 1.22+ for building